<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>CMO City Mobile</title>
<style>
body{margin:0;overflow:hidden;background:#000}
#ui{
  position:fixed;left:10px;top:10px;z-index:9999;
  background:rgba(0,0,0,.55);color:#fff;font:14px Arial;
  padding:8px 10px;border-radius:10px;display:flex;gap:8px;align-items:center;
}
#hint{
  position:fixed;left:10px;top:56px;z-index:9999;
  color:#fff;font:13px Arial;opacity:.9
}
#pad{
  position:fixed;left:20px;bottom:20px;z-index:9999;
  width:140px;height:140px;border-radius:50%;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);
  touch-action:none;
}
#stick{
  position:absolute;left:50%;top:50%;
  width:60px;height:60px;margin-left:-30px;margin-top:-30px;border-radius:50%;
  background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);
}
#jumpBtn{
  position:fixed;right:20px;bottom:30px;z-index:9999;
  width:90px;height:90px;border-radius:50%;
  background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);
  color:#fff;font:16px Arial;
}
</style>
</head>
<body>

<div id="ui">
  <div>스킨:</div>
  <select id="skin">
    <option value="#00ff66">네온그린</option>
    <option value="#ff3b3b">레드</option>
    <option value="#3b82ff">블루</option>
    <option value="#ffd43b">옐로</option>
    <option value="#c084fc">퍼플</option>
    <option value="#ffffff">화이트</option>
  </select>
  <input id="room" value="cmo-city" style="width:110px"/>
  <button id="apply">적용</button>
</div>
<div id="hint">모바일 조작: 왼쪽 이동 / 오른쪽 점프</div>

<div id="pad"><div id="stick"></div></div>
<button id="jumpBtn">JUMP</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/gun/gun.js"></script>

<script>
/* ===== 3D 기본 ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b1020);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 300);
camera.position.set(0,6,12);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(0,1,0);

scene.add(new THREE.AmbientLight(0xffffff,.35));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(8,18,8);
scene.add(sun);

/* ===== 도시 ===== */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(400,400),
  new THREE.MeshStandardMaterial({color:0x111827})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

function rand(a,b){return a+Math.random()*(b-a);}
function addBuilding(x,z){
  const h=rand(4,25);
  const b=new THREE.Mesh(
    new THREE.BoxGeometry(rand(2,6),h,rand(2,6)),
    new THREE.MeshStandardMaterial({color:0x1f2937})
  );
  b.position.set(x,h/2,z);
  scene.add(b);
}
for(let x=-80;x<=80;x+=12){
  for(let z=-80;z<=80;z+=12){
    if(Math.abs(x)<10||Math.abs(z)<10)continue;
    if(Math.random()<.5)addBuilding(x+rand(-1,1),z+rand(-1,1));
  }
}

/* ===== 플레이어 ===== */
function makeCat(color){
  const g=new THREE.Group();
  const head=new THREE.Mesh(
    new THREE.SphereGeometry(.6,24,24),
    new THREE.MeshStandardMaterial({color})
  );
  head.position.y=.8; g.add(head);
  const body=new THREE.Mesh(
    new THREE.CapsuleGeometry(.35,.6,6,16),
    new THREE.MeshStandardMaterial({color})
  );
  body.position.y=.15; g.add(body);
  return g;
}

let myColor=document.getElementById("skin").value;
let player=makeCat(myColor);
scene.add(player);

let pos={x:0,y:0,z:0};
let vy=0,onGround=true,gravity=-.012;

/* ===== 모바일 조이스틱 ===== */
let joyX=0,joyY=0;
const pad=document.getElementById("pad");
const stick=document.getElementById("stick");

function setStick(x,y){
  const r=50;
  const dx=Math.max(-r,Math.min(r,x));
  const dy=Math.max(-r,Math.min(r,y));
  stick.style.transform=`translate(${dx}px,${dy}px)`;
  joyX=dx/r; joyY=dy/r;
}
pad.addEventListener("touchstart",e=>{e.preventDefault();});
pad.addEventListener("touchmove",e=>{
  const rect=pad.getBoundingClientRect();
  const t=e.touches[0];
  setStick(t.clientX-rect.left-70,t.clientY-rect.top-70);
});
pad.addEventListener("touchend",()=>{setStick(0,0);});

document.getElementById("jumpBtn").addEventListener("touchstart",()=>{
  if(onGround){vy=.28; onGround=false;}
});

/* ===== 멀티 ===== */
const myId=Math.random().toString(36).slice(2);
const gun=Gun(["https://gun.defucc.me/gun","https://relay.peer.ooo/gun"]);
let roomName=document.getElementById("room").value;
let room=gun.get("cmo_city_"+roomName);
const others={};

room.map().on((data,id)=>{
  if(!data||id===myId)return;
  if(!others[id]){
    others[id]=makeCat(data.c||"#ff3b3b");
    scene.add(others[id]);
  }
  others[id].position.set(data.x||0,data.y||0,data.z||0);
});

function sendNet(){
  room.get(myId).put({x:pos.x,y:pos.y,z:pos.z,c:myColor});
}

document.getElementById("apply").onclick=()=>{
  myColor=document.getElementById("skin").value;
  scene.remove(player);
  player=makeCat(myColor);
  scene.add(player);
  roomName=document.getElementById("room").value;
  room=gun.get("cmo_city_"+roomName);
};

/* ===== 업데이트 ===== */
function step(){
  const sp=.1;
  pos.x+=joyX*sp*2;
  pos.z+=joyY*sp*2;

  vy+=gravity;
  pos.y+=vy;
  if(pos.y<=0){pos.y=0;vy=0;onGround=true;}

  player.position.set(pos.x,pos.y,pos.z);
  controls.target.set(pos.x,1,pos.z);
  sendNet();
}

function animate(){
  requestAnimationFrame(animate);
  step();
  controls.update();
  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
